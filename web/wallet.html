<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<body>

<div class="w3-container w3-teal">
    <h2>Wallet</h2>
</div>

<div class="w3-cell-row">

    <div class="w3-container w3-cell">
        <div class="w3-container w3-card-4">
            <p><label class="w3-text-teal"><b>Account balance</b></label><br></p>
            <table class="w3-table-all" id="balanceTable">
                <thead>
                    <tr class="w3-light-grey">
                        <th>Id</th>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <p>
                <input class="w3-btn w3-blue-grey" type=submit value="Update" onclick="httpGetAccauntBalance()">
            </p>
        </div>

        <div class="w3-container w3-card-4">
            <p>
                <label class="w3-text-teal"><b>Exchange tokens</b></label><br>
            </p>
            <p>
                <label class="w3-text-teal">Tokens to sell: </label>
                <select class="w3-input w3-border w3-light-grey" id="exchangeFrom">
                </select><br>
                <label class="w3-text-teal">Tokens to buy: </label>
                <select class="w3-input w3-border w3-light-grey" id="exchangeTo">
                </select><br>
                <label class="w3-text-teal">Amount of tokens to buy: </label><br>
                <input class="w3-input w3-border w3-light-grey" type=text id="tokensToExchange" size=65>
            </p>
            <p>
                <input class="w3-btn w3-blue-grey" type=submit value="Buy" onclick="performExchange()">
                <input class="w3-check" type="checkbox" checked="checked" id="coverWithDefault">
                <label>Cover mismatch with default token</label>
            </p>
        </div>
    </div>

    <div class="w3-container w3-cell">
        <div class="w3-container w3-card-4">
            <p>
                <label class="w3-text-teal"><b>Wallet info</b></label>
            </p>
            <p>
                <label class="w3-text-teal">Contract address: </label><br>
                <input class="w3-input w3-border w3-light-grey" type= text id="_tokenAddress" size=65>
            </p>
            <p>
                <label class="w3-text-teal">Wallet address: </label>
                <input class="w3-input w3-border w3-light-grey" type=text id="_from" size=65>
            </p>
            <p>
                <input class="w3-btn w3-blue-grey" onchange="loadKey()" type= file id="keystorage">
            </p>
        </div>

        <div class="w3-container w3-card-4">
        <p><label class="w3-text-teal"><b>Send tokens</b></label><br></p>
            <p><label class="w3-text-teal">Private key: </label><br>
                <input class="w3-input w3-border w3-light-grey" type= text id="_privateKey" size=65></p>

            <label class="w3-text-teal">Tokens to sell: </label>
            <select class="w3-input w3-border w3-light-grey" id="sendTokenId">
            </select><br>
            <p><label class="w3-text-teal">Receiver address: </label>
                <input class="w3-input w3-border w3-light-grey" type= text id="_to" size=65></p>
            <p><label class="w3-text-teal">Amount: </label><br>
                <input class="w3-input w3-border w3-light-grey" type= text id="_amount" size=65></p>

            <p><input class="w3-btn w3-blue-grey" type=submit value="Send transaction" onclick="preSignedTransaction()"></p>
        </div>
    </div>
</div>

<script type="text/javascript" src="ethereumjs-all-2018-1-17.min.js"></script>
<script>
//Parse address and private key from JSON file
function loadKey() {

    var file = document.getElementById("keystorage").files[0];
    if (file) {
        var reader = new FileReader();
        reader.readAsText(file, "UTF-8");
        reader.onload = function (evt) {
            var password = prompt("Enter key password");
            var wallet = ethereumjs.Wallet.fromV3(evt.target.result, password);
            document.getElementById("_from").value = wallet.getAddressString();
            document.getElementById("_privateKey").value = wallet.getPrivateKeyString();
            httpGetAccauntBalance();
        }
        reader.onerror = function (evt) {
            document.getElementById("fileContents").innerHTML = "error reading file";
        }
    }
}

//HTTP balance get request
function httpGetAccauntBalance()
{
    //TODO: check values
    var _contract = document.getElementById("_tokenAddress").value;
    var _owner = document.getElementById("_from").value;
    var _tokenId = 1;
    
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
            //get tbody element of table for tokens display and clean it
            var tbody = document.getElementById('balanceTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = "";

            //get option element for exchangeFrom tokens and clean it
            var exchangeFrom = document.getElementById('exchangeFrom');
            exchangeFrom.innerHTML = "";

            //get option element for exchangeTo tokens and clean it
            var exchangeTo = document.getElementById('exchangeTo');
            exchangeFrom.innerHTML = "";

            //parse array with tokens info
            var tokens = JSON.parse(xmlHttp.responseText);


            for (var i = 0; i < tokens.length; ++i) {
                //add new row to table
                var newRow = tbody.insertRow(tbody.rows.length);
                newRow.insertCell(0).appendChild(document.createTextNode(tokens[i].id));
                newRow.insertCell(1).appendChild(document.createTextNode(tokens[i].symbol));
                newRow.insertCell(2).appendChild(document.createTextNode(tokens[i].name));
                newRow.insertCell(3).appendChild(document.createTextNode(tokens[i].price));
                newRow.insertCell(4).appendChild(document.createTextNode(tokens[i].balance));

                //create new option with token info
                var opt = document.createElement('option');
                opt.innerHTML = tokens[i].name + " (" + tokens[i].symbol + "); id:" + tokens[i].id;
                opt.value = tokens[i].id;
                //and add to needed drop down lists
                exchangeFrom.appendChild(opt);
            }
            //get option element for exchangeTo tokens and copy content
            var exchangeTo = document.getElementById('exchangeTo');
            exchangeTo.innerHTML = exchangeFrom.innerHTML;
            var sendTokenId = document.getElementById('sendTokenId');
            sendTokenId.innerHTML = exchangeFrom.innerHTML;
        }
    }
    var request = "http://localhost:3000/balance?contract=" + _contract + "&owner=" + _owner + "&tokenId=" + _tokenId;
    xmlHttp.open("GET", request, true); // true for asynchronous 
    xmlHttp.send(null);
}

function performExchange()
{
    var _contract = document.getElementById("_tokenAddress").value;
    var _owner = document.getElementById("_from").value;
    var _tokenToSpendId = document.getElementById("exchangeFrom").value;
    var _tokenToBuyId = document.getElementById("exchangeTo").value;
    var _amount = document.getElementById("tokensToExchange").value;
    var _coverWithDefaultToken = document.getElementById("coverWithDefault").checked;
    var _nonce = 1;

    var xmlHttp = new XMLHttpRequest();
    var request = "http://localhost:3000/tokenExchange?contract=" + _contract +
                                               "&owner=" + _owner +
                                               "&tokenToSpendId=" + _tokenToSpendId +
                                               "&tokenToBuyId=" + _tokenToBuyId +
                                               "&nonce=" + _nonce +
                                               "&amount=" + _amount +
                                               "&cover=" + _coverWithDefaultToken;

    console.log(request);
    xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
            httpGetAccauntBalance();
        }
    }

    xmlHttp.open("POST", request, true); // true for asynchronous
    xmlHttp.send(null);

}

function preSignedTransaction()
{
    //TODO: check values
    var _from = document.getElementById("_from").value;
    var _to = document.getElementById("_to").value;
    var _amount = document.getElementById("_amount").value;
    var _privateKey = ethereumjs.Util.stripHexPrefix(document.getElementById("_privateKey").value);
    var _token = document.getElementById("_tokenAddress").value;
    var _tokenId = document.getElementById("sendTokenId").value;
    
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {   
            var nonce = xmlHttp.responseText;
            signAndPostPreSignedTransaction(_tokenId, _from, _to, _amount, _privateKey, _token, nonce);
        }
    }
    var request = "http://localhost:3000/nonce?token=" + _token + "&wallet=" + _from;
    xmlHttp.open("GET", request, true); // true for asynchronous 
    xmlHttp.send(null);
}

//HTTP post presigned transaction
function postPreSignedTransaction(_token, _tokenId, _from, _to, _value, _nonce, _signature)
{
    var xmlHttp = new XMLHttpRequest();
    var request = "http://localhost:3000/preSignedTransaction?token=" + _token +
                                               "&tokenId=" + _tokenId +
                                               "&from=" + _from +
                                               "&to=" + _to +
                                               "&value=" + _value +
                                               "&nonce=" + _nonce +
                                               "&signature=" + _signature;

    xmlHttp.open("POST", request, true); // true for asynchronous 
    xmlHttp.send(null);
}

//Prepare and send pre signed transactio with http post
function signAndPostPreSignedTransaction(_tokenId, _from, _to, _amount, _privateKey, _token, _nonce)
{
    const formattedAddress = address => ethereumjs.Buffer.Buffer(ethereumjs.Util.stripHexPrefix(address), 'hex');
    const formattedInt = int => ethereumjs.Util.setLengthLeft(int, 32);
    const formattedBytes32 = bytes => ethereumjs.Util.addHexPrefix(bytes.toString('hex'));
    const hashedTightPacked = args => ethereumjs.Util.sha3(ethereumjs.Buffer.Buffer.concat(args));
    const fixSignature = (signature) => {
    // in geth its always 27/28, in ganache its 0/1. Change to 27/28 to prevent
    // signature malleability
    // https://github.com/ethereum/go-ethereum/blob/master/internal/ethapi/api.go#L447
        const v = parseInt(signature.slice(130, 132), 16) + 27;
        const vHex = v.toString(16);
        return signature.slice(0, 130) + vHex;
    };

    components = [
        formattedInt(parseInt(_tokenId)),
        formattedAddress(_from),
        formattedAddress(_to),
        formattedInt(parseInt(_amount)),
        formattedInt(parseInt(_nonce))
    ];

    console.log(components);
    console.log(ethereumjs.Buffer.Buffer.concat(components).toString('hex'));

    const hash = hashedTightPacked(components);
    console.log(hash.toString('hex'))

    const vrs = ethereumjs.Util.ecsign(hashedTightPacked(components), ethereumjs.Buffer.Buffer(_privateKey, 'hex'));
    console.log(vrs)

    const sig = ethereumjs.Util.toRpcSig(vrs.v, vrs.r, vrs.s);
    console.log(sig.toString('hex'));

    const fixedSignature = fixSignature(sig);
    console.log(fixedSignature.toString('hex'));

    postPreSignedTransaction(_token, _tokenId, _from, _to, _amount, _nonce, fixedSignature);
}

</script>

</body>
</html>
